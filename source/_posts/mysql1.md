---
title: "MySQL：redo 和 undo"
date: 2021-04-27T20:55:29+08:00
categories:
- 学习笔记
- MySQL
tags:
- mysql
- 事务
- 调优
keywords:
- mysql事务的实现
- redo log
- undo log
comments: false
#thumbnailImage: //example.com/image.jpg
summary: MySQL通过 redo log (重做日志)和 undo log 实现了事务的持久性、原子性和一致性，本文对这两种日志进行了简单的阐述和总结。

---

<!--more-->

### redo log 作用

redo log 用以保证事务的持久性，当数据库突然宕机后重启就需要使用 redo log 恢复已经提交但是没来得及同步到磁盘上的事务。

再深挖一下为什么数据库宕机重启就需要恢复数据呢，这是因为直接将修改的数据页同步到磁盘意味着频繁的随机写入操作。懂点磁盘运行原理的同学都应该知道这样效率多低，但一直放在内存而不实时刷盘又容易丢失数据。 redo log 就可以解决这个问题，虽然也需要同步到磁盘，但是由于采取顺序写入的方式，所以同时具有效率高和不易失的优点。

这样一来，数据库就可以从容地将修改的数据页写入磁盘而不用怕突然宕机，因为可以根据 redo log 进行恢复。

### 工作机制

在InnoDB中通过Force Log at Commit机制实现事务的持久性，即当事务提交时，必须将重做日志缓冲写入重做日志文件后才算提交成功。这样就能保证成功提交的事务都被记录了下来，但是也不是绝对，后面再讲。

**两阶段提交**

这个与MySQL的binlog有关，binlog是MySQL Server层实现的，主要用于数据备份恢复和主从复制。为了保证两份日志的逻辑一致性MySQL采用了两阶段提交，提交过程可简略表示为：

写redo log （第一阶段：prepare）->  写binlog -> 写redo log (第二阶段：commit)

恢复策略可简略表示为：

- 如果redo log显示处于commit状态，说明redo log和binlog均已记录了事务，则直接提交事务

- 如果redo log显示处于prepare状态，还要看binlog是否记录了完整的事务，如果是那么就提交，否则就回滚事务

这样可以保证直接通过redo log恢复的数据库和通过binlog恢复或者说同步的（从）数据库一致

**组提交**

虽然redo log是顺序写入比随机写入快不少，但总归还是会被内存缓冲的写入速度降维打击。组提交就是用来解决这个瓶颈的，简单来说就将多个事务的写入的重做日志缓冲一次性同步到硬盘。

但是开启binlog后，binlog也有这个瓶颈，并且由于要保持两份日志的一性使得redo log组提交也废了（需要加锁以同步提交顺序和写入顺序，从而导致其他事务无法提交）。于是乎binlog也搞了个组提交，称为BLGC，就是binlog组提交的首字母缩写。

BLGC分为三个阶段：

1. flush阶段，将binlog写入内存
2. sync，一次性将多个事务的binlog刷新到磁盘（与redo log组提交同理，提高了效率）
3. commit阶段，按顺序完成事务的提交

最精华的就是最后按顺序完成事务的提交，MySQL将要提交的事务按顺序放入一个队列，队列中的第一个事务称为leader，其他事务称为follower，在最后阶段leader按顺序调用InnoDB事务的提交。

### 特点

如果数据页已经同步到了磁盘（通过LSN判断），真正持久化了，那么对应的 redo log 也就没用了。所以 redo log 有用的往往只有最新的一小段，于是可以采用循环写的方式，整体所占空间是固定的。

redo log的存储都是以 块(block) 为单位进行存储的，每个块的大小为512字节。同磁盘扇区大小一致，可以保证块的写入是原子操作。

### 参数调优

`innodb_flush_log_at_trx_commit`这个参数决定了将redo log缓存刷入磁盘的时机，默认为1，代表提交时立即刷入，0代表交给master thread完成，而master thread每一秒刷入1次，2代表写入文件系统缓存，刷入交给操作系统完成。可以将参数修改为0或2提高数据库性能，但是会失去事物的ACID特性。

### undo log 的作用

undo log的作用有两个：1. 回滚事务。2. 实现MVCC（这个有空另写一篇）

### 工作机制

undo log是逻辑日志，所以进行的是逻辑上的反向操作，插入一条数据就删除一条数据，更新一条数据就反向更新一条数据。由于同时其他事务，并不能保证数据和原来一模一样，因此不能理解成让数据库回到某一状态。

### 特点

由于undo log也需要持久化，所以undo log会产生redo log

事务提交后不能马上删除undo log，因为在MVCC还可能用的到。最后删除时记录还会寻找同一数据页中寻找其他可以删除的记录，这是为了避免随机读写。

### 参数调优

`innodb_purge_batch_size`可以设置每次purge要清理的undo page数量。参数越大则回收的页越多，磁盘空间和分配开销越小，CPU和磁盘IO开销越大。



