---
title: "TCP：握手挥手"
date: 2021-04-18T21:08:29+08:00
categories:
- 学习笔记
- 网络
tags:
- tcp
keywords:
- tcp
- 三次握手
- 四次挥手
#thumbnailImage:  /images/host/misc/tcp.png
comments: false
summary: 最近看了一些网络方面的博客和书，以前在这方面总是似懂非懂，现在换了个角度去重新认识和学习总算搞清楚了一点。就从非常基础的TCP三次握手四次挥手过程开始，梳理网络知识。
---

<!--more-->

### 什么是三次握手和四次挥手

三次握手和四次挥手是http建立连接和关闭连接过程的形象描述。这个说法比较有名，因为我们通常喜欢以类比的方式来认识未知的事物。

但是从本质原因出发去认识事物或许可以获得更深刻的认识。

### 为什么要三次握手

**主要是因为要防止旧的重复连接初始化造成混乱**

在网络状况较差的情况下，客户端在和服务端建立连接前可能会多次发起连接，为了防止因此引起混乱就需要有能够及时中止错误连接的机制。

首先要明白的一点是服务端无法知道当前收到的连接请求报文是否是最新的，所以服务端要向客户端确认是否为历史连接。

那么客户端怎么判断是否为历史连接呢？简单来说就是客户端随机发给服务端一个数，服务端把这个数加一发还给客户端，客户端判断发送的数和收到的数和收到的数是否满足加一关系就可以判断是否为历史连接。

相对具体点的流程如下：

1. 客户端发送SYN报文，其中包含客户端初始序列号seq_c
2. 服务端收到SYN报文，发送ACK确认报文，其中包含序列号seq_c+1
3. 服务端发送SYN报文，其中包含服务端初始序列号seq_s
4. 客户端收到ACK确认报文和SYN报文
    - 如果收到seq_c+1，发送ACK确认报文，包含序列号seq_s+1，连接建立
    - 否则，发送RST报文中止连接

其中有两点要**注意**：

- 因为第二步和第三步都是由服务端发送报文，所以可以并到一起，**最终只要三次通信**。
- 服务端也要发送自己的初始序列号，因为序列号在之后的通信中也要用到。

### 为什么要四次挥手

TCP连接是双向的，所以关闭连接同样需要双向确认。一方发起关闭连接请求报文，一方确认，从而关闭一个方向的连接。这个过程重复两次就有了四次挥手。

相对具体点的流程如下：

1. A端发送FIN报文
2. B端收到FIN报文，发送ACK确认报文
3. 等待一端时间后，B端发送FIN报文
4. A端收到FIN报文，发送ACK确认报文并等待一段时间

其中两段等待时间需要注意：

- 第三步中的需要等待时间是因为TCP协议栈不能替上层应用做出关闭连接的决定，所以要等上层应用反应，这也是不能合并为三次通信的原因
- 第四步需要等待时间有两个原因
    - 防止旧连接延迟到达的包影响新连接，空窗期可以直接丢弃这些包
    - 保证对方连接正确关闭，如果最后的ACK确认报文丢了，还可以处理重发的FIN包

当然最后的等待时间太长也不好，端口资源是有限的，占着茅坑不拉屎容易出问题。

