{"title":"TCP：握手挥手","uid":"b7863f675c1f74636fbdcd034261f5ad","slug":"network1","date":"2021-04-18T05:08:29.000Z","updated":"2024-06-13T14:30:24.333Z","comments":false,"path":"api/articles/network1.json","keywords":null,"cover":null,"content":"<span id=\"more\"></span>\n\n<h3 id=\"什么是三次握手和四次挥手\"><a href=\"#什么是三次握手和四次挥手\" class=\"headerlink\" title=\"什么是三次握手和四次挥手\"></a>什么是三次握手和四次挥手</h3><p>三次握手和四次挥手是http建立连接和关闭连接过程的形象描述。这个说法比较有名，因为我们通常喜欢以类比的方式来认识未知的事物。</p>\n<p>但是从本质原因出发去认识事物或许可以获得更深刻的认识。</p>\n<h3 id=\"为什么要三次握手\"><a href=\"#为什么要三次握手\" class=\"headerlink\" title=\"为什么要三次握手\"></a>为什么要三次握手</h3><p><strong>主要是因为要防止旧的重复连接初始化造成混乱</strong></p>\n<p>在网络状况较差的情况下，客户端在和服务端建立连接前可能会多次发起连接，为了防止因此引起混乱就需要有能够及时中止错误连接的机制。</p>\n<p>首先要明白的一点是服务端无法知道当前收到的连接请求报文是否是最新的，所以服务端要向客户端确认是否为历史连接。</p>\n<p>那么客户端怎么判断是否为历史连接呢？简单来说就是客户端随机发给服务端一个数，服务端把这个数加一发还给客户端，客户端判断发送的数和收到的数和收到的数是否满足加一关系就可以判断是否为历史连接。</p>\n<p>相对具体点的流程如下：</p>\n<ol>\n<li>客户端发送SYN报文，其中包含客户端初始序列号seq_c</li>\n<li>服务端收到SYN报文，发送ACK确认报文，其中包含序列号seq_c+1</li>\n<li>服务端发送SYN报文，其中包含服务端初始序列号seq_s</li>\n<li>客户端收到ACK确认报文和SYN报文<ul>\n<li>如果收到seq_c+1，发送ACK确认报文，包含序列号seq_s+1，连接建立</li>\n<li>否则，发送RST报文中止连接</li>\n</ul>\n</li>\n</ol>\n<p>其中有两点要<strong>注意</strong>：</p>\n<ul>\n<li>因为第二步和第三步都是由服务端发送报文，所以可以并到一起，<strong>最终只要三次通信</strong>。</li>\n<li>服务端也要发送自己的初始序列号，因为序列号在之后的通信中也要用到。</li>\n</ul>\n<h3 id=\"为什么要四次挥手\"><a href=\"#为什么要四次挥手\" class=\"headerlink\" title=\"为什么要四次挥手\"></a>为什么要四次挥手</h3><p>TCP连接是双向的，所以关闭连接同样需要双向确认。一方发起关闭连接请求报文，一方确认，从而关闭一个方向的连接。这个过程重复两次就有了四次挥手。</p>\n<p>相对具体点的流程如下：</p>\n<ol>\n<li>A端发送FIN报文</li>\n<li>B端收到FIN报文，发送ACK确认报文</li>\n<li>等待一端时间后，B端发送FIN报文</li>\n<li>A端收到FIN报文，发送ACK确认报文并等待一段时间</li>\n</ol>\n<p>其中两段等待时间需要注意：</p>\n<ul>\n<li>第三步中的需要等待时间是因为TCP协议栈不能替上层应用做出关闭连接的决定，所以要等上层应用反应，这也是不能合并为三次通信的原因</li>\n<li>第四步需要等待时间有两个原因<ul>\n<li>防止旧连接延迟到达的包影响新连接，空窗期可以直接丢弃这些包</li>\n<li>保证对方连接正确关闭，如果最后的ACK确认报文丢了，还可以处理重发的FIN包</li>\n</ul>\n</li>\n</ul>\n<p>当然最后的等待时间太长也不好，端口资源是有限的，占着茅坑不拉屎容易出问题。</p>\n","text":" 什么是三次握手和四次挥手三次握手和四次挥手是http建立连接和关闭连接过程的形象描述。这个说法比较有名，因为我们通常喜欢以类比的方式来认识未知的事物。 但是从本质原因出发去认识事物或许可以获得更深刻的认识。 为什么要三次握手主要是因为要防止旧的重复连接初始化造成混乱 在网络状况...","link":"","photos":[],"count_time":{"symbolsCount":992,"symbolsTime":"1 mins."},"categories":[{"name":"学习笔记","slug":"学习笔记","count":9,"path":"api/categories/学习笔记.json"},{"name":"网络","slug":"学习笔记/网络","count":2,"path":"api/categories/学习笔记/网络.json"}],"tags":[{"name":"tcp","slug":"tcp","count":2,"path":"api/tags/tcp.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B\"><span class=\"toc-text\">什么是三次握手和四次挥手</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B\"><span class=\"toc-text\">为什么要三次握手</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B\"><span class=\"toc-text\">为什么要四次挥手</span></a></li></ol>","author":{"name":"年鲤","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"喜欢折腾，随性而为<br/>sunfish69@163.com","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"TCP：序列号与滑动窗口","uid":"dcd5fd0682cc948a30be92bebe89ab9a","slug":"network2","date":"2021-04-20T05:40:26.000Z","updated":"2024-06-13T14:30:24.333Z","comments":false,"path":"api/articles/network2.json","keywords":null,"cover":null,"text":" 序列号的作用上一篇博客中提到了序列号在建立tcp连接中的作用。不光如此，序列号还是tcp可靠传输的基础。 为了可靠传输就要防止丢包，所以接受端需要向发送端确认，就像我们收到快递包裹也要确认收货。类比来讲，序列号就像是快递单号。 但是与现实不同的是，tcp包数量庞大。这就造成： ...","link":"","photos":[],"count_time":{"symbolsCount":610,"symbolsTime":"1 mins."},"categories":[{"name":"学习笔记","slug":"学习笔记","count":9,"path":"api/categories/学习笔记.json"},{"name":"网络","slug":"学习笔记/网络","count":2,"path":"api/categories/学习笔记/网络.json"}],"tags":[{"name":"tcp","slug":"tcp","count":2,"path":"api/tags/tcp.json"}],"author":{"name":"年鲤","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"喜欢折腾，随性而为<br/>sunfish69@163.com","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"杂谈（一）","uid":"56062437aab4c6050adec4f20774c673","slug":"misc1","date":"2021-04-18T02:17:09.000Z","updated":"2021-06-26T04:56:29.216Z","comments":false,"path":"api/articles/misc1.json","keywords":null,"cover":[],"text":" 今天到手的就是上面这把黑峡谷x3了，现在打字用的就是它。 直肠子的一句话总结300价位 、 87配列、双模（2.4g wifi和有线）、手感不错 （凯华box轴体）、可充电 配件送了type-c数据线、手托、拔键器、防尘盖，还算良心。目前没发现啥问题。 之所以买了这把键盘呢，主...","link":"","photos":[],"count_time":{"symbolsCount":706,"symbolsTime":"1 mins."},"categories":[{"name":"杂谈","slug":"杂谈","count":1,"path":"api/categories/杂谈.json"},{"name":"折腾日常","slug":"杂谈/折腾日常","count":1,"path":"api/categories/杂谈/折腾日常.json"}],"tags":[{"name":"硬件","slug":"硬件","count":2,"path":"api/tags/硬件.json"},{"name":"键盘","slug":"键盘","count":1,"path":"api/tags/键盘.json"}],"author":{"name":"年鲤","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"喜欢折腾，随性而为<br/>sunfish69@163.com","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}